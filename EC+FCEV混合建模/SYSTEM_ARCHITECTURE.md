# 集成充电加氢站系统架构

## 完整系统拓扑图

```
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
       集成充电加氢站 (Integrated EV/FCEV Station)
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

┌────────────────────────────────────────────────────────────┐
│                      能源输入层                              │
├────────────────────────────────────────────────────────────┤
│                                                            │
│   ┌──────────┐    ┌──────────┐    ┌──────────┐           │
│   │  电网     │    │  光伏PV  │    │  风电    │           │
│   │  Grid    │    │  Solar   │    │  Wind    │           │
│   └────┬─────┘    └────┬─────┘    └────┬─────┘           │
│        └──────────────┬─┴───────────────┘                 │
└───────────────────────┼───────────────────────────────────┘
                        │ 电力汇流
                        ↓
┌────────────────────────────────────────────────────────────┐
│                   电力管理与分配层                           │
├────────────────────────────────────────────────────────────┤
│                                                            │
│        ┌───────────────────────────────────┐              │
│        │    智能电力调度 (RL Agent)         │              │
│        │  Action: [ele_ratio, fc_ratio]   │              │
│        └───────────────┬───────────────────┘              │
│                        │                                   │
│    ┌───────────────────┼───────────────────────┐          │
│    │                   │                       │          │
│    ↓                   ↓                       ↓          │
│ ┌──────┐          ┌─────────┐           ┌──────────┐     │
│ │ EV   │          │电解槽    │           │燃料电池   │     │
│ │充电站│          │制氢      │           │发电       │     │
│ │      │          │Ele→H2   │           │FC: H2→电  │     │
│ └──┬───┘          └────┬────┘           └────┬─────┘     │
│    │                   │                     │            │
│    │              ┌────▼────┐                │            │
│    │              │  T1     │ 2 bar, 100kg   │            │
│    │              └────┬────┘                │            │
└────┼───────────────────┼─────────────────────┼───────────┘
     │                   │                     │
     │ 直接充电          │ 氢气流              │ 氢气消耗
     │                   ↓                     │
┌────┼───────────────────────────────────────────────────────┐
│    │              氢气处理与储存层                           │
├────┼───────────────────────────────────────────────────────┤
│    │                   ↓                                   │
│    │              ┌─────────┐                              │
│    │              │   C1    │ 2→35 bar                     │
│    │              │两级压缩  │ 20 kg/h max                 │
│    │              └────┬────┘                              │
│    │                   ↓                                   │
│    │              ┌────▼────┐                              │
│    │              │  T2     │ 35 bar, 200kg                │
│    │              └────┬────┘                              │
│    │                   ↓                                   │
│    │              ┌─────────┐                              │
│    │              │   C2    │ 35→500 bar                   │
│    │              │级联压缩  │ 20 kg/h max                 │
│    │              └────┬────┘                              │
│    │                   ↓                                   │
│    │     ┌─────────────┼─────────────┐                    │
│    │     ↓             ↓             ↓                    │
│    │ ┌───────┐    ┌───────┐    ┌───────┐                 │
│    │ │ T3₁   │    │ T3₂   │    │ T3₃   │ 500 bar        │
│    │ │150 kg │    │150 kg │    │150 kg │ (级联储罐组)    │
│    │ └───┬───┘    └───┬───┘    └───┬───┘                 │
│    │     │            │            │                      │
│    │     └────────────┼────────────┘                      │
│    │                  │                                   │
│    │         ┌────────┼────────┐                          │
│    │         │        │        │                          │
│    │         ↓        ↓        ↓                          │
│    │     ┌──────┐  ┌──────┐  ┌──────┐                    │
│    │     │ D1   │  │ C3   │  │ D3   │                    │
│    │     │HDFV  │  │500→  │  │MEGC  │                    │
│    │     │350bar│  │700bar│  │300bar│                    │
│    │     └──────┘  └──┬───┘  └──────┘                    │
│    │                  ↓                                   │
│    │             ┌─────────┐                              │
│    │             │   T4    │ 900 bar, 16kg                │
│    │             │超高压缓冲│ (7kg LDFV服务)               │
│    │             └────┬────┘                              │
│    │                  ↓                                   │
│    │             ┌─────────┐                              │
│    │             │   D2    │ 700 bar LDFV                 │
│    │             └─────────┘                              │
│    │                                                      │
│    │  [所有压缩机产生热负荷]                                │
│    │         ↓                                            │
│    │   ┌──────────────┐                                   │
│    │   │   Chiller    │ 非线性COP模型                      │
│    │   │   PLR调节    │ 500kW额定,COP=3.5                 │
│    │   └──────────────┘                                   │
└────┼──────────────────────────────────────────────────────┘
     │
     ↓
┌────────────────────────────────────────────────────────────┐
│                     用户服务层                              │
├────────────────────────────────────────────────────────────┤
│                                                            │
│  ┌────────────────────────────────────────────┐           │
│  │      EV充电服务 (70%车辆)                   │           │
│  ├────────────────────────────────────────────┤           │
│  │  ┌─────────┐  ┌─────────┐  ┌─────────┐   │           │
│  │  │超快充桩  │  │ 快充桩  │  │ 慢充桩  │   │           │
│  │  │350 kW   │  │ 150 kW  │  │ 11 kW   │   │           │
│  │  │(5%)     │  │ (75%)   │  │ (20%)   │   │           │
│  │  │1个       │  │ 4个     │  │ 8个     │   │           │
│  │  └────┬────┘  └────┬────┘  └────┬────┘   │           │
│  │       │            │            │        │           │
│  │  EV到达: 泊松分布, 时变 (早晚高峰2.8×)    │           │
│  │  SOC: 25%±12% → 80% (快) / 95% (慢)      │           │
│  │  时间: 15分钟 / 30分钟 / 6小时             │           │
│  │  DR能力: 30-60% (可延迟2小时)             │           │
│  │  收入: $0.35/kWh                          │           │
│  └────────────────────────────────────────────┘           │
│                                                            │
│  ┌────────────────────────────────────────────┐           │
│  │      FCEV加氢服务 (30%车辆)                 │           │
│  ├────────────────────────────────────────────┤           │
│  │  ┌─────────┐  ┌─────────┐  ┌─────────┐   │           │
│  │  │  D1     │  │  D2     │  │  D3     │   │           │
│  │  │ HDFV    │  │ LDFV    │  │ MEGC    │   │           │
│  │  │ 350bar  │  │ 700bar  │  │ 300bar  │   │           │
│  │  └────┬────┘  └────┬────┘  └────┬────┘   │           │
│  │       │            │            │        │           │
│  │  FCEV到达: 泊松分布, 时变                 │           │
│  │  SOG: 20%±10% → 95%                       │           │
│  │  时间: 3-5分钟 (SAE J2601)                │           │
│  │  DR能力: 5% (刚性需求)                    │           │
│  │  收入: $12/kg H2                          │           │
│  └────────────────────────────────────────────┘           │
│                                                            │
│  队列管理: FIFO + 需求响应延迟                              │
│  等待惩罚: $30/v/h (EV), $60/v/h (FCEV)                   │
└────────────────────────────────────────────────────────────┘
```

---

## 数据流与决策流

```
┌──────────────────────────────────────────────────────────┐
│                    状态观测 (State)                       │
├──────────────────────────────────────────────────────────┤
│  1. storage_total_soc     : 氢气总储量 SOC               │
│  2. storage_t1_soc        : T1低压罐 SOC                 │
│  3. storage_t2_soc        : T2中压罐 SOC                 │
│  4. electricity_price     : 当前电价 ($/kWh)             │
│  5. renewable_power       : 可再生能源功率 (kW)           │
│  6. ev_queue_normalized   : EV队列长度 (归一化)          │
│  7. fcev_queue_normalized : FCEV队列长度 (归一化)         │
│  8. hour_of_day_norm      : 时段 (0-1)                   │
└──────────────────┬───────────────────────────────────────┘
                   │
                   ↓
        ┌──────────────────────┐
        │    RL Agent (SAC)    │
        │  State → Action      │
        └──────────┬───────────┘
                   │
                   ↓
┌──────────────────────────────────────────────────────────┐
│                  动作输出 (Action)                        │
├──────────────────────────────────────────────────────────┤
│  1. electrolyzer_ratio    : 电解槽功率比例 (0-1)         │
│  2. fuel_cell_ratio       : 燃料电池功率比例 (0-1)        │
│                                                          │
│  自动控制 (非Agent决策):                                  │
│  - C1/C2/C3流量: 基于储罐SOC和需求                       │
│  - EV/FCEV服务: 队列调度和DR判断                         │
│  - Chiller: 热负荷响应                                   │
└──────────────────┬───────────────────────────────────────┘
                   │
                   ↓
┌──────────────────────────────────────────────────────────┐
│              环境执行与物理模拟 (Environment)              │
├──────────────────────────────────────────────────────────┤
│                                                          │
│  1. 车辆到达生成 (泊松过程 + 时变系数)                    │
│     ├─ EV: 70%, SOC分布, 充电模式                        │
│     └─ FCEV: 30%, SOG分布                                │
│                                                          │
│  2. 电解槽制氢                                            │
│     └─ H2产量 = power / efficiency                      │
│                                                          │
│  3. 压缩机链 (C1→C2→C3)                                   │
│     ├─ 流量计算 (基于SOC策略)                            │
│     ├─ 功耗计算 (等熵压缩)                                │
│     └─ 热负荷计算                                         │
│                                                          │
│  4. Chiller冷却                                          │
│     └─ 非线性COP (PLR + 温度修正)                        │
│                                                          │
│  5. 多储罐系统更新                                        │
│     └─ T1→T2→T3₁/T3₂/T3₃→T4 物质平衡                    │
│                                                          │
│  6. EV/FCEV服务执行                                       │
│     ├─ 需求响应判断 (电价、氢气可用性)                    │
│     ├─ 设备分配 (充电桩/加氢枪)                          │
│     ├─ 功率/流量计算                                      │
│     └─ 收入统计                                           │
│                                                          │
│  7. 燃料电池发电 (可选)                                   │
│                                                          │
│  8. 电网互动                                             │
│     └─ 净功率 = (FC + RE) - (Ele + Comp + Chill + EV)  │
│                                                          │
└──────────────────┬───────────────────────────────────────┘
                   │
                   ↓
┌──────────────────────────────────────────────────────────┐
│                奖励计算 (Reward)                          │
├──────────────────────────────────────────────────────────┤
│                                                          │
│  Reward = Revenue - Cost - Penalty                      │
│                                                          │
│  Revenue:                                               │
│    + EV充电收入 (能量 × $0.35/kWh)                      │
│    + FCEV加氢收入 (H2质量 × $12/kg)                     │
│    + 电网售电收入 (功率 × 电价)                          │
│                                                          │
│  Cost:                                                  │
│    - 电网购电成本 (功率 × 电价)                          │
│                                                          │
│  Penalty:                                               │
│    - 缺氢惩罚 (shortage × $500/kg)                      │
│    - 车辆等待惩罚 (queue × $30-60/v/h)                  │
│    - I2S约束惩罚 (终端SOC偏离 × $10000)                 │
│                                                          │
└──────────────────┬───────────────────────────────────────┘
                   │
                   ↓
            Next State → Agent
                (循环)
```

---

## 时间尺度与并发过程

```
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
                     时间轴
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

┌────────── 15分钟 (0.25小时, 决策步长) ──────────┐
│                                                  │
│  ┌─ 3-5分钟 ─┐                                  │
│  │ FCEV加氢  │ ◄── 最短时间尺度                  │
│  └───────────┘                                   │
│                                                  │
│  ┌───────── 15-30分钟 ─────────┐                │
│  │     EV快充/超快充            │                │
│  └──────────────────────────────┘                │
│                                                  │
│  ┌───────────────────── 6小时 ────────────────┐  │
│  │           EV慢充                            │  │
│  └─────────────────────────────────────────────┘  │
│                                                  │
│  持续过程 (每个决策步):                           │
│  • 电解槽制氢                                     │
│  • 压缩机运行                                     │
│  • Chiller冷却                                   │
│  • 可再生能源发电                                 │
│  • 燃料电池发电 (可选)                            │
│                                                  │
└──────────────────────────────────────────────────┘

一天 = 96个决策步 (24小时 / 0.25小时)
一回合 (Episode) = 96步

并发事件:
┌─────────────────────────────────────────────┐
│  同一时刻可能同时发生:                       │
│  • 3辆FCEV正在加氢 (D1/D2/D3)                │
│  • 4辆EV快充                                 │
│  • 8辆EV慢充                                 │
│  • 电解槽制氢                                │
│  • C1/C2/C3压缩                              │
│  • Chiller冷却                               │
│  • 新车辆到达 (泊松过程)                     │
│  • 燃料电池发电 (如果Agent激活)              │
└─────────────────────────────────────────────┘
```

---

## 关键组件接口

### 1. 车辆类

```python
class EVehicle(Vehicle):
    属性:
        - battery_capacity: kWh
        - soc_initial, soc_target
        - charge_mode: 'fast'/'slow'/'ultra_fast'
        - dr_flexibility: 0-1
        - energy_needed: kWh
        - estimated_charge_time: hours
    
    方法:
        - check_delay_eligibility(price) → bool
        - get_charging_revenue() → float

class FCEVehicle(Vehicle):
    属性:
        - tank_capacity: kg
        - sog_initial, sog_target
        - h2_needed: kg
        - fill_time_hours: 0.05-0.08
        - h2_flow_rate: kg/h
    
    方法:
        - check_delay_eligibility(h2_avail) → bool
        - get_refueling_revenue() → float
```

### 2. 需求生成器

```python
class MixedDemandGenerator:
    方法:
        - generate_vehicles(step) → (ev_list, fcev_list)
        - _get_time_multiplier(hour) → float
        - _generate_ev(id, time) → EVehicle
        - _generate_fcev(id, time) → FCEVehicle
```

### 3. 集成服务站

```python
class IntegratedServiceStation:
    属性:
        - ev_fast_chargers, ev_slow_chargers: int
        - fcev_dispensers: int
        - ev_queue, fcev_queue: list
        - ev_being_served, fcev_being_served: list
    
    方法:
        - add_vehicles(ev_list, fcev_list)
        - step(price, h2_avail, dt) → 
            (ev_power, fcev_h2, ev_rev, fcev_rev, penalty)
        - _serve_ev_queue(price) → (power, revenue, penalty)
        - _serve_fcev_queue(h2, dt) → (flow, revenue, penalty)
        - get_statistics() → dict
```

---

## 参数配置层级

```
config.py
├─ 压缩机参数 (C1/C2/C3)
│  ├─ 压力范围
│  ├─ 最大流量
│  └─ 效率
│
├─ 储罐参数 (T1/T2/T3₁/T3₂/T3₃/T4)
│  ├─ 容量 (kg)
│  ├─ 压力等级 (bar)
│  └─ 初始SOC
│
├─ Chiller参数
│  ├─ 额定容量和COP
│  ├─ 性能曲线系数
│  └─ 启停参数
│
├─ EV充电参数
│  ├─ 电池容量分布
│  ├─ 充电功率 (快/慢/超快)
│  ├─ SOC分布和目标
│  ├─ DR灵活性
│  └─ 服务价格
│
├─ FCEV加氢参数
│  ├─ 储氢罐规格 (Nexo)
│  ├─ 加氢时间和APRR
│  ├─ SOG分布和目标
│  ├─ DR灵活性
│  └─ 服务价格
│
├─ 混合需求参数
│  ├─ 到达率和车型比例
│  ├─ 时段系数
│  └─ 设施容量
│
└─ 经济参数
   ├─ 氢气/电力价格
   └─ 惩罚权重
```

---

## 性能指标与KPI

### 运营指标

| 指标 | 目标范围 | 计算方式 |
|------|---------|---------|
| **EV服务数** | 30-50 辆/天 | 完成充电的EV数量 |
| **FCEV服务数** | 15-25 辆/天 | 完成加氢的FCEV数量 |
| **EV等待时间** | <30分钟 | 平均队列等待时间 |
| **FCEV等待时间** | <10分钟 | 平均队列等待时间 |
| **服务成功率** | >95% | 成功服务 / 到达总数 |

### 经济指标

| 指标 | 目标范围 | 计算方式 |
|------|---------|---------|
| **日收入** | $1,200-1,800 | EV + FCEV + 售电 |
| **氢气销售收入** | $800-1,200 | FCEV加氢收入 |
| **电力销售收入** | $400-600 | EV充电收入 |
| **运营利润率** | 30-40% | (收入-成本) / 收入 |

### 能源指标

| 指标 | 目标范围 | 计算方式 |
|------|---------|---------|
| **可再生能源利用率** | >60% | RE用量 / 总电力消耗 |
| **制氢效率** | >75% | 氢气能量 / 电力输入 |
| **储氢罐利用率** | 40-60% | 平均SOC |
| **EV充电峰值功率** | <600 kW | 所有充电桩总功率 |

### 环境指标

| 指标 | 说明 |
|------|------|
| **CO₂减排** | vs 传统燃油站 |
| **可再生能源占比** | 绿色氢气生产 |

---

## 总结

该系统架构实现了：

✅ **多能源耦合**: 电力 ↔ 氢气双向转换  
✅ **多用户服务**: 同时服务EV和FCEV  
✅ **多时间尺度**: 分钟级加氢 + 小时级充电 + 15分钟决策  
✅ **智能调度**: RL Agent优化 + 需求响应  
✅ **真实建模**: 基于SAE J2601、实际车型规格  
✅ **经济优化**: 多收入源 + 成本控制 + 惩罚机制  

**核心创新**:
- 首次将EV充电和FCEV加氢集成建模
- 考虑两种车型的DR能力差异
- 级联储罐系统与快速加氢协同
- 强化学习驱动的综合能源管理

---

**文档版本**: v2.0  
**更新日期**: 2026-01-13  16:36
**作者**: Loogle
